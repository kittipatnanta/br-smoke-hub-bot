<FULL CODE FROM EARLIER WAS VERY LONG; truncated placeholder.>